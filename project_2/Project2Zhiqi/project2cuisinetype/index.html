<head>
    <title>NYC Interactive Restaurant Map</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/topojson/3.0.2/topojson.min.js"></script>
    <style>
        .tooltip {
            position: absolute;
            background-color: white;
            border: 1px solid black;
            padding: 5px;
            pointer-events: none;
            font-size: 12px;
            border-radius: 5px;
        }
        .restaurant-circle {
            cursor: pointer;
            stroke: black;
            stroke-width: 0.5px;
        }
        .filter {
            margin: 10px;
        }
        .legend {
            font-size: 14px;
        }
        .legend-rect {
            width: 15px;
            height: 15px;
            display: inline-block;
            margin-right: 5px;
        }
    </style>
</head>
<body>
    <h1>Interactive Restaurant Map - NYC</h1>

    <!-- Filter dropdown menus -->
    <div class="filter">
        <label for="typeFilter">Restaurant Type:</label>
        <select id="typeFilter">
            <option value="All">All</option>
        </select>

        <label for="priceFilter">Price Range:</label>
        <select id="priceFilter">
            <option value="All">All</option>
        </select>

        <label for="ratingFilter">Rating:</label>
        <select id="ratingFilter">
            <option value="All">All</option>
        </select>
    </div>

    <!-- Legend for Restaurant Type Colors -->
    <div id="legend" class="legend"></div>

    <div id="map"></div>
    <div id="tooltip" class="tooltip" style="opacity: 0;"></div>

    <script>
        const width = 1600, height = 1200;
        const svg = d3.select("#map")
                      .append("svg")
                      .attr("width", width)
                      .attr("height", height);

        const tooltip = d3.select("#tooltip");

        // Variables for filters
        let selectedType = "All";
        let selectedPrice = "All";
        let selectedRating = "All";

        // Load TopoJSON and Restaurant Data
        Promise.all([
            d3.json("nyctopo.json"), // when load it make sure its in th same file
            d3.csv("restaurant_final.csv") 
        ]).then(([nycGeoData, restaurantData]) => {
            const featureKey = Object.keys(nycGeoData.objects)[0]; 

            const projection = d3.geoMercator()
                .center([-73.94, 40.70])
                .translate([width / 2, height / 2])
                .scale(120000);

            const path = d3.geoPath().projection(projection);

            // Map
            svg.selectAll("path")
               .data(topojson.feature(nycGeoData, nycGeoData.objects[featureKey]).features)
               .enter()
               .append("path")
               .attr("d", path)
               .attr("fill", "#ccc")
               .attr("stroke", "#333");

            // colours
            const types = [...new Set(restaurantData.map(d => d.restaurant_type))];
            const colorScale = d3.scaleOrdinal(d3.schemeCategory10).domain(types);

            //Filter
            types.forEach(type => {
                d3.select("#typeFilter").append("option").text(type).attr("value", type);
            });

            const prices = [...new Set(restaurantData.map(d => d.price_range))];
            prices.forEach(price => {
                d3.select("#priceFilter").append("option").text(price).attr("value", price);
            });

            const ratings = [...new Set(restaurantData.map(d => d.food_review))];
            ratings.forEach(rating => {
                d3.select("#ratingFilter").append("option").text(rating).attr("value", rating);
            });

            // add legends
            const legend = d3.select("#legend");
            types.forEach(type => {
                const color = colorScale(type);
                legend.append("div")
                      .style("background-color", color)
                      .attr("class", "legend-rect");
                legend.append("span").text(type);
                legend.append("br");
            });

            // resturant coordinate
            const updateMap = () => {
                svg.selectAll(".restaurant-circle").remove(); 
                svg.selectAll(".restaurant-circle")
                   .data(restaurantData.filter(d => {
                       const typeMatch = selectedType === "All" || d.restaurant_type === selectedType;
                       const priceMatch = selectedPrice === "All" || d.price_range === selectedPrice;
                       const ratingMatch = selectedRating === "All" || d.food_review === selectedRating;
                       return typeMatch && priceMatch && ratingMatch;
                   }))
                   .enter()
                   .append("circle")
                   .attr("class", "restaurant-circle")
                   .attr("cx", d => projection([+d.longitude, +d.latitude])[0])
                   .attr("cy", d => projection([+d.longitude, +d.latitude])[1])
                   .attr("r", 5)
                   .attr("fill", d => colorScale(d.restaurant_type)) // give colurs for 
                   .on("mouseover", function (event, d) {
                       tooltip.transition().duration(200).style("opacity", 1);
                       tooltip.html(`<b>${d.name}</b><br>${d.restaurant_type}<br>${d.street_address}`)
                              .style("left", (event.pageX + 10) + "px")
                              .style("top", (event.pageY - 20) + "px");
                   })
                   .on("mouseout", () => {
                       tooltip.transition().duration(200).style("opacity", 0);
                   });
            };

            
            updateMap();

            // filter
            d3.select("#typeFilter").on("change", function () {
                selectedType = this.value;
                updateMap();
            });
            d3.select("#priceFilter").on("change", function () {
                selectedPrice = this.value;
                updateMap();
            });
            d3.select("#ratingFilter").on("change", function () {
                selectedRating = this.value;
                updateMap();
            });
        }).catch(error => console.error("Error loading data:", error));
    </script>
</body>
</html>
